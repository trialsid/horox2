<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horoscope Kiosk</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Varela Round", serif;
        background-color: #d3d3d3; /* Light gray background */
        color: #343a40;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .form-card {
        background-color: #fff;
        border-radius: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 800px;
        margin: 20px auto;
        text-align: center;
      }

      .form-card h2 {
        color: #0000ff; /* Blue title */
        text-align: center;
        margin-bottom: 25px;
        font-size: 2.2rem;
        font-weight: 700;
        text-transform: uppercase;
      }

      .form-label {
        color: #0000ff;
        margin-bottom: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: left;
      }

      .form-control {
        border-radius: 10px;
        border: 2px solid #d3d3d3;
        padding: 12px;
        font-size: 1.1rem;
      }

      .btn {
        border-radius: 15px;
        padding: 12px 25px;
        font-weight: 600;
        font-size: 1.1rem;
        width: auto;
        margin-top: 10px;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background-color: #0000ff;
        border-color: #0000ff;
      }

      .btn-primary:hover {
        background-color: #0000b3;
        border-color: #0000b3;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background-color: #28a745;
        border-color: #28a745;
      }

      .btn-secondary:hover {
        background-color: #1e7e34;
        border-color: #1e7e34;
        transform: translateY(-2px);
      }

      .btn-success {
        background-color: #28a745;
        border-color: #28a745;
      }

      .btn-success:hover {
        background-color: #1e7e34;
        border-color: #1e7e34;
        transform: translateY(-2px);
      }

      .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
      }

      .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
        transform: translateY(-2px);
      }

      .error-message {
        color: #dc3545;
        margin-top: 5px;
        font-weight: 500;
        font-size: 0.9rem;
        text-align: left;
      }

      #start-btn {
        font-size: 2 rem; /* Increased font size */
        border-radius: 50px; /* Fully rounded corners */
        padding: 10px 60px; /* Increased padding */
      }

      #status-container {
        margin-top: 25px;
        padding: 25px;
        border-radius: 30px;
        text-align: center;
        background-color: #fff;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        display: none;
      }

      #text-container {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        background-color: #f8f9fa;
        font-size: 1.2rem;
        line-height: 1.8;
        text-align: left;
        white-space: pre-wrap;
        font-weight: 500;
      }

      .remaining-count {
        color: #6c757d;
        font-size: 0.9rem;
        font-style: italic;
        margin-top: 8px;
        display: block;
      }

      #playing-message,
      #completed-message {
        font-weight: 700;
        margin-top: 15px;
        font-size: 1.3rem;
        color: #28a745;
      }

      #message-container {
        font-size: 1.4rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 15px;
      }

      #total-time {
        margin-top: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #6c757d;
      }

      .button-center {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      #kill-switch-btn {
        border-radius: 15px; /* Rounded corners */
        width: 150px; /* Width */
        padding: 20px 15px; /* Vertical and horizontal padding */
        font-size: 1.2rem;
        line-height: 1.4;
        display: flex;
        flex-direction: column; /* Stack text vertically */
        justify-content: center;
        align-items: center;
        white-space: pre-line; /* Allow line breaks */
        text-align: center;
      }

      @media (max-width: 768px) {
        .form-card {
          padding: 20px;
          margin: 10px;
        }

        .form-card h2 {
          font-size: 1.8rem;
        }

        .form-control,
        .btn {
          font-size: 1rem;
          padding: 10px 20px;
        }

        #text-container {
          font-size: 1.1rem;
          padding: 15px;
        }

        #playing-message,
        #completed-message {
          font-size: 1.2rem;
        }

        #message-container {
          font-size: 1.2rem;
        }
      }

      .audio-controls {
        background: #fff;
        border-radius: 30px;
        padding: 20px;
        margin: 20px auto;
        max-width: 600px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .device-selector {
        margin-bottom: 15px;
        display: none;
      }

      .stream-status {
        display: none;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
        padding: 10px;
        border-radius: 5px;
        background: #f8f9fa;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
      }

      .level-meter {
        height: 20px;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .level-meter-fill {
        height: 100%;
        width: 0%;
        background: #28a745;
        transition: width 0.1s ease;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .stream-duration {
        font-family: monospace;
        font-size: 1.1em;
      }

      .device-list {
        max-height: 200px;
        overflow-y: auto;
      }

      .device-item {
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        cursor: pointer;
      }

      .device-item:hover {
        background: #f8f9fa;
      }

      .device-item.selected {
        border-color: #28a745;
        background: #e8f5e9;
      }

      .choice-btn {
        margin-top: 20px;
        width: 45%;
        max-width: 300px;
      }
      .pin-container {
        margin-top: 20px;
        text-align: center;
      }
      .pin-input {
        margin: 0 auto;
        width: 150px;
        text-align: center;
        border: 2px solid #d3d3d3;
      }
      .pin-error {
        color: red;
        margin-top: 5px;
      }
      .choice-text {
        color: #0000ff;
        margin-bottom: 25px;
        font-size: 1.3rem;
        font-weight: 500;
      }
      #form-container label {
        text-align: left;
        display: block;
      }

      #form-container input,
      #form-container textarea {
        margin-bottom: 15px;
      }

      /* Form Layout Styling */
      #form-container .mb-3 {
        display: flex;
        align-items: center;
      }

      #form-container .form-label {
        flex: 0 0 150px; /* Fixed width for labels */
        text-align: right;
        padding-right: 20px; /* Space between label and input */
      }

      #form-container .form-control {
        flex: 1; /* Input takes remaining space */
      }

      /* Mobile Styles */
      @media (max-width: 768px) {
        #form-container .mb-3 {
          flex-direction: column;
          align-items: flex-start;
        }

        #form-container .form-label {
          text-align: left;
          padding-right: 0;
          margin-bottom: 2px;
          flex: 0 0 auto; /* Reset flex to allow label to take only necessary height */
        }
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  </head>
  <body>
    <div class="container" id="start-page">
      <div class="form-card">
        <h2 class="mb-4">HOROSCOPE KIOSK</h2>
        <button id="start-btn" class="btn btn-primary">Start</button>
      </div>
    </div>

    <div class="container" id="choice-page" style="display: none">
      <div class="form-card">
        <h2 class="mb-4">HOROSCOPE KIOSK</h2>
        <div class="choice-text">choose an option</div>
        <button id="enter-details-btn" class="btn btn-primary choice-btn">
          Enter Details
        </button>
        <button id="listen-details-btn" class="btn btn-secondary choice-btn">
          Listen Details
        </button>
      </div>
    </div>

    <div class="container">
      <div class="form-card" id="form-container" style="display: none">
        <h2 class="mb-4">HOROSCOPE KIOSK</h2>
        <div class="choice-text">enter details</div>
        <form id="horoscopeForm" method="post" action="/">
          <div class="mb-3">
            <label for="name" class="form-label">Name:</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              required
            />
            <div class="error-message" id="nameError"></div>
          </div>
          <div class="mb-3">
            <label for="place_of_birth" class="form-label"
              >Place of Birth:</label
            >
            <input
              type="text"
              class="form-control"
              id="place_of_birth"
              name="place_of_birth"
              required
            />
            <div class="error-message" id="pobError"></div>
          </div>
          <div class="mb-3">
            <label for="dob" class="form-label">Date of Birth (mm-yyyy):</label>
            <input
              type="text"
              class="form-control"
              id="dob"
              name="dob"
              placeholder="mm-yyyy"
              required
            />
            <div class="error-message" id="dobError"></div>
          </div>
          <div class="mb-3">
            <label for="problem" class="form-label">Problem (Optional):</label>
            <textarea
              class="form-control"
              id="problem"
              name="problem"
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="occupation" class="form-label"
              >Occupation (Optional):</label
            >

            <input
              type="text"
              class="form-control"
              id="occupation"
              name="occupation"
            />
          </div>
          <button type="button" id="generate-btn" class="btn btn-primary">
            Submit
          </button>
        </form>
      </div>
    </div>

    <div class="container" id="pin-verification-page" style="display: none">
      <div class="form-card">
        <h2 class="mb-4">HOROSCOPE KIOSK</h2>
        <div class="choice-text">Details Saved</div>
        <div id="pin-container" class="pin-container">
          <input
            type="password"
            id="pin-input"
            class="form-control pin-input"
            placeholder="Enter PIN"
            maxlength="4"
          />
          <div id="pin-error" class="pin-error"></div>
          <button
            type="button"
            id="verify-pin-btn"
            class="btn btn-primary mt-2"
          >
            Verify PIN
          </button>
        </div>
      </div>
    </div>
    <div class="container">
      <div id="status-container" style="display: none">
        <div id="message-container"></div>
        <div id="text-container"></div>
        <div id="playing-message" style="display: none">
          Horoscope playing...
        </div>
        <div id="completed-message" style="display: none"></div>
        <div
          id="error-message-speech"
          class="error-message"
          style="display: none"
        ></div>
        <div id="total-time" style="display: none"></div>
        <button
          id="kill-switch-btn"
          class="btn btn-danger"
          style="margin-top: 15px"
        >
          Stop Horoscope
        </button>
        <div class="button-center">
          <button
            id="new-start-btn"
            class="btn btn-success"
            style="display: none"
            onclick="resetForm()"
          >
            Start Again
          </button>
        </div>
      </div>
    </div>

    <div class="container" id="listen-details-page" style="display: none">
      <div class="audio-controls">
        <h3 class="mb-3" style="color: #0000ff">Audio Stream Controls</h3>

        <!-- Initial Start Button -->
        <button id="start-stream-btn" class="btn btn-primary w-100">
          Start Audio Stream
        </button>

        <!-- Device Selector -->
        <div id="device-selector" class="device-selector">
          <h4 style="color: #0000ff">Select Input Device</h4>
          <div id="device-list" class="device-list"></div>
        </div>

        <!-- Stream Status -->
        <div id="stream-status" class="stream-status">
          <div class="status-dot"></div>
          <span id="current-device">No device selected</span>
          <span id="stream-duration" class="stream-duration">00:00:00</span>
          <div class="level-meter">
            <div id="level-meter-fill" class="level-meter-fill"></div>
          </div>
          <button id="stop-stream-btn" class="btn btn-danger w-100 mt-2">
            Stop Stream
          </button>
        </div>
      </div>
    </div>
    <!-- Confirmation Modal -->
    <div
      class="modal fade"
      id="confirm-stop-modal"
      tabindex="-1"
      aria-labelledby="confirm-stop-modal-label"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirm-stop-modal-label">
              Confirm Stop
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Are you sure you want to stop the horoscope?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirm-stop-btn">
              Stop
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Function to reset the UI to its initial state
      function resetUI() {
        console.log("DEBUG: resetUI called");
        // Reset messages
        document.getElementById("nameError").textContent = "";
        document.getElementById("pobError").textContent = "";
        document.getElementById("dobError").textContent = "";
        document.getElementById("message-container").textContent = "";
        document.getElementById("text-container").textContent = "";
        document.getElementById("pin-error").textContent = "";

        // Reset display states
        document.getElementById("playing-message").style.display = "none";
        document.getElementById("completed-message").style.display = "none";
        document.getElementById("error-message-speech").style.display = "none";
        document.getElementById("total-time").style.display = "none";
        document.getElementById("new-start-btn").style.display = "none";
        document.getElementById("pin-container").style.display = "";
        document.getElementById("status-container").style.display = "none";
        console.log("DEBUG: resetUI - Hiding pin-verification-page");
        document.getElementById("pin-verification-page").style.display = "none";
        console.log("DEBUG: resetUI - pin-verification-page hidden");

        // Reset saved form data
        savedFormData = null;
        console.log("DEBUG: savedFormData reset");
        console.log("DEBUG: resetUI completed");
      }

      // Function to reset the form
      function resetForm() {
        console.log("DEBUG: resetForm called");
        // Navigate to the start page
        document.getElementById("choice-page").style.display = "none";
        document.getElementById("form-container").style.display = "none";
        document.getElementById("listen-details-page").style.display = "none";
        document.getElementById("start-page").style.display = "block";

        // Reset form
        document.getElementById("horoscopeForm").reset();

        // Call the resetUI function
        resetUI();
        console.log("DEBUG: resetForm completed");
      }

      // Function to submit the form
      function submitForm() {
        console.log("DEBUG: submitForm called");
        // Hide form and PIN verification page, show status container
        document.getElementById("form-container").style.display = "none";
        document.getElementById("pin-verification-page").style.display = "none";
        document.getElementById("status-container").style.display = "block";

        // Show "Stop Horoscope" button
        document.getElementById("kill-switch-btn").style.display = "block";

        // Show "generating" message
        document.getElementById("message-container").textContent =
          "Generating horoscope...";

        // Continue with fetch...
        console.log("DEBUG: Sending form data with fetch");
        fetch("/", {
          method: "POST",
          body: savedFormData, // Use the saved form data
        })
          .then((response) => {
            console.log("DEBUG: fetch response received", response);
            if (!response.ok) {
              return response.json().then((err) => {
                throw new Error(JSON.stringify(err));
              });
            }
            return response.json();
          })
          .then((data) => {
            console.log("DEBUG: fetch data received", data);
            if (data.error) {
              throw new Error(data.error);
            }

            // --- UI UPDATES BEFORE resetUI() ---

            // Truncate text and show remaining count
            const fullText = data.fullText;
            const truncatedText = fullText.slice(0, 75) + "...";
            const remainingCount = fullText.length - 75;

            const textContainer = document.getElementById("text-container");
            textContainer.innerHTML = truncatedText;

            if (remainingCount > 0) {
              const remainingCountElement = document.createElement("span");
              remainingCountElement.className = "remaining-count";
              remainingCountElement.textContent = `${remainingCount} more characters`;
              textContainer.appendChild(remainingCountElement);
            }

            // Update message to "Horoscope Playing..."
            document.getElementById("message-container").textContent =
              "Horoscope playing...";

            // Make sure the status container is visible
            document.getElementById("status-container").style.display = "block";

            // --- END OF UI UPDATES ---

            // Wait 60 seconds before starting to check status
            setTimeout(() => {
              let checkCount = 0;
              const maxChecks = 60; // Maximum number of checks (1 minute with 2-second interval)

              function checkSpeechStatus() {
                console.log("DEBUG: checkSpeechStatus called");
                checkCount++;
                fetch("/speech_status")
                  .then((response) => response.json())
                  .then((statusData) => {
                    console.log("DEBUG: speech status received", statusData);
                    if (statusData.completed || checkCount >= maxChecks) {
                      // Speech is done or we've reached max checks
                      if (
                        statusData.completed &&
                        statusData.startTime &&
                        statusData.endTime
                      ) {
                        // Update message to "Completed" only after completion
                        document.getElementById(
                          "message-container"
                        ).textContent = "Completed";

                        const totalTime =
                          (new Date(statusData.endTime) -
                            new Date(statusData.startTime)) /
                          1000;
                        document.getElementById(
                          "total-time"
                        ).textContent = `Total Time: ${totalTime.toFixed(
                          2
                        )} seconds`;
                        document.getElementById("total-time").style.display =
                          "block";
                        // Hide stop button and show start again button
                        document.getElementById(
                          "kill-switch-btn"
                        ).style.display = "none";
                        document.getElementById("new-start-btn").style.display =
                          "block";
                      } else if (checkCount < maxChecks) {
                        // If not completed, keep the message as "Horoscope playing..."
                        document.getElementById(
                          "message-container"
                        ).textContent = "Horoscope playing...";
                      } else {
                        document.getElementById(
                          "message-container"
                        ).textContent = "Playback finished";
                        // Hide stop button and show start again button
                        document.getElementById(
                          "kill-switch-btn"
                        ).style.display = "none";
                        document.getElementById("new-start-btn").style.display =
                          "block";
                      }
                    } else if (checkCount < maxChecks) {
                      // Check again in 2 seconds
                      console.log(
                        "DEBUG: Checking speech status again in 2 seconds"
                      );
                      setTimeout(checkSpeechStatus, 3000);
                    }
                  })
                  .catch((error) => {
                    console.error("DEBUG: Error checking status:", error);
                    // Stop checking on error
                    document.getElementById("message-container").textContent =
                      "Playback finished";
                    document.getElementById("new-start-btn").style.display =
                      "block";
                  });
              }

              // Start checking status after 60 seconds
              checkSpeechStatus();
            }, 10000);
          })
          .catch((error) => {
            console.error("DEBUG: fetch error", error);
            document.getElementById("message-container").textContent =
              "An error occurred. Please try again.";
            document.getElementById("form-container").style.display = "block";
            document.getElementById("status-container").style.display = "none";
          });
        console.log("DEBUG: submitForm completed");
      }

      let savedFormData = null;

      // Event listener for 'generate-btn'
      document
        .getElementById("generate-btn")
        .addEventListener("click", function (event) {
          console.log("DEBUG: generate-btn clicked");
          event.preventDefault();
          let isValid = true;

          // Form validation
          const nameInput = document.getElementById("name");
          if (!nameInput.value.trim()) {
            document.getElementById("nameError").textContent =
              "Name is required.";
            isValid = false;
          } else {
            document.getElementById("nameError").textContent = "";
          }

          const pobInput = document.getElementById("place_of_birth");
          if (!pobInput.value.trim()) {
            document.getElementById("pobError").textContent =
              "Place of Birth is required.";
            isValid = false;
          } else {
            document.getElementById("pobError").textContent = "";
          }

          const dobInput = document.getElementById("dob");
          const dobRegex = /^(0[1-9]|1[0-2])-\d{4}$/;
          if (!dobInput.value.trim()) {
            document.getElementById("dobError").textContent =
              "Date of Birth is required.";
            isValid = false;
          } else if (!dobRegex.test(dobInput.value)) {
            document.getElementById("dobError").textContent =
              "Invalid date format. Use mm-yyyy.";
            isValid = false;
          } else {
            document.getElementById("dobError").textContent = "";
          }

          if (isValid) {
            // Hide the form
            console.log("DEBUG: generate-btn - Hiding form-container");
            document.getElementById("form-container").style.display = "none";
            // Show the PIN verification page
            console.log("DEBUG: generate-btn - Showing pin-verification-page");
            document.getElementById("pin-verification-page").style.display =
              "block";
            // Save the form data to the variable
            savedFormData = new FormData(
              document.getElementById("horoscopeForm")
            );
            console.log("DEBUG: Form data saved", savedFormData);
          } else {
            console.log("DEBUG: Form validation failed");
            document.getElementById("message-container").textContent =
              "Please fix the errors and try again.";
            document.getElementById("form-container").style.display = "block";
            document.getElementById("status-container").style.display = "none";
          }
        });

      // Event listener for 'verify-pin-btn'
      document
        .getElementById("verify-pin-btn")
        .addEventListener("click", function () {
          console.log("DEBUG: verify-pin-btn clicked");
          const enteredPIN = document.getElementById("pin-input").value;

          fetch("/verify_pin", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ pin: enteredPIN }),
          })
            .then((response) => {
              console.log(
                "DEBUG: PIN verification response received",
                response
              );
              return response.json();
            })
            .then((data) => {
              console.log("DEBUG: PIN verification data received", data);
              if (data.result === "success") {
                // Hide PIN verification page
                document.getElementById("pin-verification-page").style.display =
                  "none";
                // Reset PIN input and error message
                document.getElementById("pin-input").value = "";
                document.getElementById("pin-error").textContent = "";
                // Submit the form
                submitForm();
              } else {
                document.getElementById("pin-error").textContent =
                  "Incorrect PIN. Please try again.";
              }
            })
            .catch((error) => {
              console.error("DEBUG: Error verifying PIN:", error);
              document.getElementById("pin-error").textContent =
                "Error verifying PIN. Please try again.";
            });
        });

      // Hide form and status container initially
      document.getElementById("form-container").style.display = "none";
      document.getElementById("status-container").style.display = "none";
      document.getElementById("listen-details-page").style.display = "none";

      // Start button click handler
      document
        .getElementById("start-btn")
        .addEventListener("click", function () {
          console.log("DEBUG: start-btn clicked");
          document.getElementById("start-page").style.display = "none";
          document.getElementById("choice-page").style.display = "block";
        });

      // Enter details button click handler
      document
        .getElementById("enter-details-btn")
        .addEventListener("click", function () {
          console.log("DEBUG: enter-details-btn clicked");
          document.getElementById("choice-page").style.display = "none";
          document.getElementById("form-container").style.display = "block";
        });

      // Listen details button
      document
        .getElementById("listen-details-btn")
        .addEventListener("click", function () {
          console.log("DEBUG: listen-details-btn clicked");
          document.getElementById("choice-page").style.display = "none";
          document.getElementById("listen-details-page").style.display =
            "block";
        });

      let audioContext;
      let socket = io();
      let streamStartTime = null;

      window.onload = function () {
        if (socket && socket.connected) {
          socket.disconnect();
        }
        socket = io();
      };

      let durationInterval = null;

      // Initialize audio context
      async function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }
      }

      // Update duration display
      function updateDuration() {
        if (!streamStartTime) return;

        const now = new Date();
        const diff = now - streamStartTime;
        const hours = Math.floor(diff / 3600000)
          .toString()
          .padStart(2, "0");
        const minutes = Math.floor((diff % 3600000) / 60000)
          .toString()
          .padStart(2, "0");
        const seconds = Math.floor((diff % 60000) / 1000)
          .toString()
          .padStart(2, "0");

        document.getElementById(
          "stream-duration"
        ).textContent = `${hours}:${minutes}:${seconds}`;
      }

      // Start stream button click handler
      document
        .getElementById("start-stream-btn")
        .addEventListener("click", async () => {
          console.log("DEBUG: start-stream-btn clicked");
          try {
            // Get available devices
            const response = await fetch("/get_devices");
            const devices = await response.json();

            // Show device selector
            const deviceList = document.getElementById("device-list");
            deviceList.innerHTML = "";

            devices.forEach((device) => {
              const deviceEl = document.createElement("div");
              deviceEl.className = "device-item";
              deviceEl.textContent = device.name;
              deviceEl.dataset.deviceId = device.id;

              deviceEl.addEventListener("click", () => selectDevice(device.id));
              deviceList.appendChild(deviceEl);
            });

            document.getElementById("device-selector").style.display = "block";
            document.getElementById("start-stream-btn").style.display = "none";
          } catch (error) {
            console.error("Error getting devices:", error);
            alert("Error getting audio devices");
          }
        });

      // Device selection handler
      async function selectDevice(deviceId) {
        console.log("DEBUG: selectDevice called with deviceId", deviceId);
        try {
          const response = await fetch("/start_audio", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ deviceId }),
          });

          const result = await response.json();

          if (result.success) {
            await initAudio();
            streamStartTime = new Date();

            // Update UI
            document.getElementById("device-selector").style.display = "none";
            document.getElementById("stream-status").style.display = "flex";
            document.getElementById("current-device").textContent =
              result.deviceName;

            // Start duration counter
            durationInterval = setInterval(updateDuration, 1000);
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          console.error("Error starting stream:", error);
          alert("Error starting audio stream");
        }
      }

      // Stop stream button handler
      document
        .getElementById("stop-stream-btn")
        .addEventListener("click", async () => {
          console.log("DEBUG: stop-stream-btn clicked");
          try {
            const response = await fetch("/stop_audio", { method: "POST" });
            const result = await response.json();

            if (result.success) {
              // Reset UI
              document.getElementById("stream-status").style.display = "none";
              document.getElementById("start-stream-btn").style.display =
                "block";

              // Clear intervals
              clearInterval(durationInterval);
              streamStartTime = null;
            } else {
              throw new Error(result.message);
            }
          } catch (error) {
            console.error("Error stopping stream:", error);
            alert("Error stopping audio stream");
          }
        });

      // Audio stream handling
      socket.on("audio_stream", function (data) {
        console.log("DEBUG: audio_stream event received");
        if (!audioContext) return;

        // Convert int16 audio data to float32
        const audioBuffer = new Int16Array(data.audio);
        const float32Data = new Float32Array(audioBuffer.length);
        for (let i = 0; i < audioBuffer.length; i++) {
          float32Data[i] = audioBuffer[i] / 32767;
        }

        // Calculate audio level from float32 data
        const sum = float32Data.reduce((acc, val) => acc + val * val, 0);
        const rms = Math.sqrt(sum / float32Data.length);
        const level = Math.min(100, Math.max(0, rms * 300)); // Adjust multiplier as needed
        document.getElementById("level-meter-fill").style.width = `${level}%`;

        // Create audio buffer with received parameters
        const buffer = audioContext.createBuffer(
          data.channels || 1,
          float32Data.length,
          data.rate || 48000
        );
        buffer.copyToChannel(float32Data, 0);

        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start();
      });

      // Kill switch functionality
      document
        .getElementById("kill-switch-btn")
        .addEventListener("click", function () {
          console.log("DEBUG: kill-switch-btn clicked");
          // Show the confirmation modal
          var confirmStopModal = new bootstrap.Modal(
            document.getElementById("confirm-stop-modal")
          );
          confirmStopModal.show();
        });

      document
        .getElementById("confirm-stop-btn")
        .addEventListener("click", function () {
          console.log("DEBUG: confirm-stop-btn clicked");
          socket.emit("stop_process");
          // Hide the modal
          var confirmStopModal = bootstrap.Modal.getInstance(
            document.getElementById("confirm-stop-modal")
          );
          confirmStopModal.hide();

          // Update UI immediately to reflect the stop action
          document.getElementById("message-container").textContent =
            "Stopping horoscope...";
          document.getElementById("playing-message").style.display = "none";
          document.getElementById("kill-switch-btn").style.display = "none"; // Hide the stop button again
        });

      socket.on("process_killed", function (data) {
        console.log("DEBUG: process_killed event received", data);
        document.getElementById("message-container").textContent = data.message;
        // Always show the Start Again button when process is killed
        document.getElementById("new-start-btn").style.display = "block";
        document.getElementById("total-time").style.display = "none";
        // Ensure kill switch button is hidden
        document.getElementById("kill-switch-btn").style.display = "none";
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
